<% content_for :title, @pdf_document.title %>

<% if @pdf_document.content.blank? || @pdf_document.content.include?("Error processing PDF") %>
  <meta http-equiv="refresh" content="5">
<% end %>

<div class="container mx-auto px-4 py-8">
  <div class="flex items-center mb-8">
    <%= link_to pdf_documents_path, class: "text-blue-500 hover:text-blue-700 mr-4" do %>
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
      </svg>
    <% end %>
    <h1 class="text-3xl font-bold text-gray-800"><%= @pdf_document.title %></h1>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- PDF Information Panel -->
    <div class="lg:col-span-1">
      <div class="bg-white shadow-md rounded-lg p-6 sticky top-4 space-y-6">
        <div>
          <h2 class="text-xl font-semibold text-gray-800 mb-4">Document Information</h2>
          
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-600">Filename</label>
              <p class="text-gray-900"><%= @pdf_document.filename || "Unknown" %></p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-600">Pages</label>
              <p class="text-gray-900"><%= @pdf_document.page_count || "Unknown" %></p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-600">Uploaded</label>
              <p class="text-gray-900"><%= @pdf_document.uploaded_at&.strftime("%B %d, %Y at %I:%M %p") %></p>
            </div>
          </div>
        </div>

        <!-- Extracted Key Information -->
        <% if @pdf_document.licensor.present? || @pdf_document.licensee.present? || @pdf_document.address.present? %>
          <div class="border-t pt-4">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Key Information</h3>
            
            <div class="space-y-3">
              <% if @pdf_document.licensor.present? %>
                <div>
                  <label class="block text-sm font-medium text-gray-600">Licensor/Owner</label>
                  <p class="text-gray-900 text-sm"><%= @pdf_document.licensor %></p>
                </div>
              <% end %>
              
              <% if @pdf_document.licensee.present? %>
                <div>
                  <label class="block text-sm font-medium text-gray-600">Licensee/Tenant</label>
                  <p class="text-gray-900 text-sm"><%= @pdf_document.licensee %></p>
                </div>
              <% end %>
              
              <% if @pdf_document.address.present? %>
                <div>
                  <label class="block text-sm font-medium text-gray-600">Property Address</label>
                  <p class="text-gray-900 text-sm"><%= @pdf_document.address %></p>
                </div>
              <% end %>
              
              <% if @pdf_document.agreement_date.present? %>
                <div>
                  <label class="block text-sm font-medium text-gray-600">Agreement Date</label>
                  <p class="text-gray-900 text-sm"><%= @pdf_document.agreement_date.strftime("%B %d, %Y") %></p>
                </div>
              <% end %>
              
              <% if @pdf_document.agreement_period.present? %>
                <div>
                  <label class="block text-sm font-medium text-gray-600">Agreement Period</label>
                  <p class="text-gray-900 text-sm"><%= @pdf_document.agreement_period %></p>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <div class="border-t pt-4 space-y-3">
          <% if @pdf_document.content.present? %>
            <%= link_to "View All Data", data_view_pdf_document_path(@pdf_document),
                class: "w-full bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded text-center block transition duration-200" %>
          <% end %>
          
          <!-- Download functionality removed with Active Storage -->
          <div class="w-full bg-gray-300 text-gray-600 py-2 px-4 rounded text-center block mb-3">
            File Download Disabled
          </div>
          
          <% if @pdf_document.content.present? %>
            <%= link_to "Reprocess Data", reprocess_pdf_document_path(@pdf_document), method: :patch,
                confirm: "This will re-extract and filter the PDF data. Continue?",
                class: "w-full bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-center block transition duration-200" %>
          <% end %>
          
          <%= link_to "Delete Document", pdf_document_path(@pdf_document), method: :delete,
              confirm: "Are you sure you want to delete this PDF document?",
              class: "w-full bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded text-center block transition duration-200" %>
        </div>
      </div>
    </div>

    <!-- PDF Content Panel -->
    <div class="lg:col-span-2">
      <div class="bg-white shadow-md rounded-lg p-6">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-semibold text-gray-800">Extracted Content</h2>
          <div class="flex space-x-2">
            <% if @pdf_document.content.blank? || @pdf_document.content.include?("Error processing PDF") %>
              <button onclick="location.reload()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm transition duration-200">
                Refresh
              </button>
            <% end %>
            <% if @pdf_document.content.present? && !@pdf_document.content.include?("Error processing PDF") %>
              <button onclick="copyToClipboard('pdf-content')" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded text-sm transition duration-200">
                Copy Raw Text
              </button>
            <% end %>
            <% if @pdf_document.filtered_data.present? %>
              <button onclick="copyToClipboard('filtered-content')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm transition duration-200">
                Copy Filtered Data
              </button>
            <% end %>
          </div>
        </div>
        
        <% if @pdf_document.content.present? %>
          <% if @pdf_document.content.include?("Error processing PDF") %>
            <div class="text-center py-12">
              <svg class="mx-auto h-12 w-12 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z" />
              </svg>
              <h3 class="mt-2 text-sm font-medium text-gray-900">Processing Error</h3>
              <p class="mt-1 text-sm text-gray-500"><%= @pdf_document.content %></p>
              <div class="mt-4">
                <button onclick="location.reload()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                  Try Again
                </button>
              </div>
            </div>
          <% else %>
            <!-- Tab Navigation -->
            <div class="border-b border-gray-200 mb-6">
              <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <% if @pdf_document.filtered_data.present? %>
                  <button onclick="showTab('filtered')" id="filtered-tab" class="border-transparent text-blue-600 border-b-2 border-blue-500 py-2 px-1 text-sm font-medium" aria-current="page">
                    Filtered Data
                  </button>
                  <button onclick="showTab('raw')" id="raw-tab" class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 border-b-2 py-2 px-1 text-sm font-medium">
                    Raw Text
                  </button>
                <% else %>
                  <button class="border-transparent text-blue-600 border-b-2 border-blue-500 py-2 px-1 text-sm font-medium" aria-current="page">
                    Extracted Text
                  </button>
                <% end %>
              </nav>
            </div>

            <!-- Filtered Data Tab -->
            <% if @pdf_document.filtered_data.present? %>
              <div id="filtered-content-tab" class="tab-content">
                <div class="bg-blue-50 p-6 rounded-lg border border-blue-200 mb-4">
                  <h3 class="text-lg font-semibold text-blue-800 mb-3">Extracted Key Information</h3>
                  <div id="filtered-content" class="text-blue-800 whitespace-pre-wrap font-mono text-sm leading-relaxed">
<%= @pdf_document.filtered_data %>
                  </div>
                </div>
                
                <div class="text-sm text-gray-600">
                  <p><strong>Data Points Extracted:</strong> <%= @pdf_document.filtered_data.lines.count %></p>
                </div>
              </div>
            <% end %>

            <!-- Raw Text Tab -->
            <div id="raw-content-tab" class="tab-content <%= 'hidden' if @pdf_document.filtered_data.present? %>">
              <div class="prose max-w-none">
                <div id="pdf-content" class="bg-gray-50 p-6 rounded-lg border text-gray-800 whitespace-pre-wrap font-mono text-sm leading-relaxed max-h-96 overflow-y-auto">
<%= @pdf_document.content %>
                </div>
              </div>
              
              <div class="mt-4 text-sm text-gray-600">
                <p><strong>Character Count:</strong> <%= @pdf_document.content.length %></p>
                <p><strong>Word Count:</strong> <%= @pdf_document.content.split.length %></p>
              </div>
            </div>
          <% end %>
        <% else %>
          <div class="text-center py-12">
            <div class="flex justify-center mb-4">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            </div>
            <h3 class="mt-2 text-sm font-medium text-gray-900">Processing PDF...</h3>
            <p class="mt-1 text-sm text-gray-500">
              Text extraction and data filtering is in progress. This page will automatically refresh when complete.
            </p>
            <div class="mt-4">
              <button onclick="location.reload()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                Check Status
              </button>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
  function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
    
    // Remove active styles from all tabs
    document.querySelectorAll('[id$="-tab"]').forEach(tab => {
      tab.classList.remove('text-blue-600', 'border-blue-500');
      tab.classList.add('text-gray-500', 'border-transparent');
    });
    
    // Show the selected tab
    document.getElementById(tabName + '-content-tab').classList.remove('hidden');
    
    // Add active styles to the selected tab
    const selectedTab = document.getElementById(tabName + '-tab');
    selectedTab.classList.remove('text-gray-500', 'border-transparent');
    selectedTab.classList.add('text-blue-600', 'border-blue-500');
  }

  function copyToClipboard(elementId) {
    const content = document.getElementById(elementId).textContent;
    navigator.clipboard.writeText(content).then(function() {
      // Show a temporary success message
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = 'Copied!';
      button.classList.remove('bg-gray-500', 'hover:bg-gray-700', 'bg-blue-500', 'hover:bg-blue-700');
      button.classList.add('bg-green-500');
      
      setTimeout(function() {
        button.textContent = originalText;
        button.classList.remove('bg-green-500');
        if (originalText.includes('Raw')) {
          button.classList.add('bg-gray-500', 'hover:bg-gray-700');
        } else {
          button.classList.add('bg-blue-500', 'hover:bg-blue-700');
        }
      }, 2000);
    }).catch(function(err) {
      console.error('Could not copy text: ', err);
      alert('Failed to copy text to clipboard');
    });
  }
</script>
